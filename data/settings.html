<!DOCTYPE html>
<html lang="pl-PL">
    <head>
        <title>ESP32</title>
        <meta charset='UTF-8'>
        <link rel="stylesheet" href="style.css">
        <script>

        const INPUT_0 = %INPUT_0%;
        const INPUT_SETTINGS_SIZE = %INPUT_SETTINGS_SIZE%;
        const INPUT_SIZE = %INPUT_SIZE%;
        const DATA_0 = %DATA_0%;
        const DATA_SETTINGS_SIZE = %DATA_SETTINGS_SIZE%;
        const DATA_SIZE = %DATA_SIZE%;

        function send(){
          let data = new FormData();

%settings_js%

          let xhr = new XMLHttpRequest();
          xhr.open('POST', 'settingsSet');
          xhr.onload = function(){ console.log(this.response); };
          xhr.send(data);
          return false;
        }

        function post(s) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', s);
            xhr.send(null);
        }

        function preset(i) {
            let preset = parseInt(document.getElementById('input_' + i + '_preset').value);

            switch (preset) {
                case -1:
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 0).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 1).selectedIndex = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 2).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 3).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 4).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 5).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 6).value = 0;
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 1).value = "";
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 2).value = "u";
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 3).value = 0;
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 4).value = 0;
                    break;
                case 0:
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 0).value = 101.5;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 1).selectedIndex = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 2).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 3).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 4).value = 3.0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 5).value = 160.0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE + 6).value = 10.0;
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 1).value = "Oil press";
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 2).value = "bar";
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 3).value = 0;
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  + 4).value = 12;
                    break;
                case 1:
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  0).value = 10110.0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  1).selectedIndex = 1;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  2).value = 3800.0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  3).value = 58000.0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  4).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  5).value = 0;
                    document.getElementById(INPUT_0 + i * INPUT_SETTINGS_SIZE +  6).value = 0;
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  +  1).value = "Oil temp";
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  +  2).value = "°C";
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  +  3).value = 30;
                    document.getElementById(DATA_0  + i * DATA_SETTINGS_SIZE  +  4).value = 150;
                    break;
            }
        }

        if (!!window.EventSource) {
            var source = new EventSource('/events');

            source.addEventListener('open', function(e) {
                console.log("Events Connected");
            }, false);

            source.addEventListener('error', function(e) {
                if (e.target.readyState != EventSource.OPEN) {
                    console.log("Events Disconnected");
                }
            }, false);

            source.addEventListener('message', function(e) {
                console.log("message", e.data);
            }, false);

            source.addEventListener('myevent', function(e) {
                console.log("myevent", e.data);
            }, false);

            source.addEventListener('frametime', function(e) {
                document.getElementById("frametime").innerText = "frametime: " + e.data;
            }, false);
        }

        </script>
    </head>
    <body>
        <form onsubmit='return send()'>
            <h1>Ustawienia</h1><p id='frametime'>frametime: </p>
            <button type="button" onclick='post("reset"); window.location.reload(true);'>Przywróć domyślne</button>
            <button type="button" onclick='post("time"); window.location.reload(true);'>Wymuś synchrunizację czasu</button>
            %settings%
            <h2>Wejścia analogowe</h2>
            %input_table%
            <h2>Ustawienia danych</h2>
            %data_list%
            </br><input type='submit'>
        </form>
    </body>
</html>