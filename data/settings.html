<!DOCTYPE html>
<html lang="pl-PL">
    <head>
        <title>ESP32</title>
        <meta charset='UTF-8'>
        <link rel="stylesheet" href="style.css">
        <script>

            %CONSTS%

            let source;

            function setEventSource() {
                if (!!window.EventSource) {
                    source = new EventSource('/events');

                    source.addEventListener('open', function(e) {
                        console.log("Events Connected");
                    }, false);

                    source.addEventListener('error', function(e) {
                        if (e.target.readyState != EventSource.OPEN) {
                            console.log("Events Disconnected");
                        }
                    }, false);

                    source.addEventListener('data', function(e) {
                        console.log("data", e.data);
                        const json = JSON.parse(e.data);
                        for(let i=0; i<7; i++) {
                            if(json.hasOwnProperty(i)) {
                                document.getElementById("voltage_" + i).innerText = "Voltage: " + json[i][0] + "V";
                                document.getElementById("resistance_" + i).innerText = "Resistance: " + json[i][1] + "Ω";
                                document.getElementById("value_" + i).innerText = "Value: " + json[i][2];
                            } else {
                                document.getElementById("voltage_" + i).innerText = "Voltage: 0V";
                                document.getElementById("resistance_" + i).innerText = "Resistance: 0Ω;";
                                document.getElementById("value_" + i).innerText = "Value: 0";
                            }
                        }
                    }, false);

                    source.addEventListener('frametime', function(e) {
                        document.getElementById("frametime").innerText = "frametime: " + e.data;
                    }, false);
                }
            }

            setEventSource();


        function send(){
            source.close();
          let data = new FormData();

%settings_js%

          let xhr = new XMLHttpRequest();
          xhr.open('POST', 'settingsSet');
          xhr.onload = function(){ console.log(this.response); };
          xhr.send(data);
          setEventSource();
          return false;
        }

        function post(s) {
            source.close();
            let xhr = new XMLHttpRequest();
            xhr.open('POST', s);
            xhr.send(null);
            setEventSource();
        }

        function calibration() {
            let data = new FormData();
            data.append("mac", MAC);
            let xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://217.11.128.153:1337/calibration.php');
            xhr.onload = function(){
                console.log(this.status);
                console.log(this.response);
                const json = JSON.parse(this.response);
                for(let i=0; i<7; i++) {
                    if(json.hasOwnProperty(i)) {
                        document.getElementById(INPUT_BEGIN_BEGIN + INPUT_SETTINGS_SIZE*i + 0).value = json[i][0];
                        document.getElementById(INPUT_BEGIN_BEGIN + INPUT_SETTINGS_SIZE*i + 1).value = json[i][1];
                        document.getElementById(INPUT_BEGIN_BEGIN + INPUT_SETTINGS_SIZE*i + 2).value = json[i][2];
                    }
                }
                // window.location.reload(true);
            };
            xhr.send(data);
        }

        function resetSettings() {
            source.close();
            let xhr = new XMLHttpRequest();
            xhr.open('POST', "reset");
            xhr.onload = function(){
                console.log(this.status);
                window.location.reload(true);
            };
            xhr.send(null);
        }

        function preset(i) {
            let preset = parseInt(document.getElementById('input_' + i + '_preset').value);

            switch (preset) {
                case -1:
                    document.getElementById(INPUT_BEGIN_BEGIN + i * INPUT_SETTINGS_SIZE + 0).value = 0;
                    document.getElementById(INPUT_BEGIN_BEGIN + i * INPUT_SETTINGS_SIZE + 1).value = 0;
                    document.getElementById(INPUT_BEGIN_BEGIN + i * INPUT_SETTINGS_SIZE + 2).value = 0;
                    document.getElementById(INPUT_BEGIN_BEGIN + i * INPUT_SETTINGS_SIZE + 3).value = "v";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 1).value = "";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 2).value = "u";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 3).value = 0;
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 4).value = 0;
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 5).value = 0;
                    break;
                case 0:
                    document.getElementById(INPUT_BEGIN_BEGIN + i * INPUT_SETTINGS_SIZE + 3).value = "(r-3)/(160-3)*10";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 1).value = "Oil press";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 2).value = "bar";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 3).value = 0;
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 4).value = 12;
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 5).value = 1;
                    break;
                case 1:
                    document.getElementById(INPUT_BEGIN_BEGIN + i * INPUT_SETTINGS_SIZE + 3).value = "3800*298.15/(3800+(298.15)*log(r/58000))-273.15";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 1).value = "Oil temp";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 2).value = "°C";
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 3).value = 30;
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 4).value = 150;
                    document.getElementById(DATA_BEGIN_BEGIN  + i * DATA_SETTINGS_SIZE  + 5).value = 1;
                    break;
            }
        }


        </script>
    </head>
    <body>
        <form onsubmit='return send()'>
            <h1>Ustawienia</h1><p id='frametime'>frametime: </p>
            <button type="button" onclick='resetSettings();'>Przywróć domyślne</button>
            <button type="button" onclick='post("time");'>Wymuś synchrunizację czasu</button>
            %settings%
            <h2>Wejścia analogowe</h2>
            <button type="button" onclick='calibration();'>Get calibration data</button>
            %input_table%
            <h2>Ustawienia danych</h2>
            %data_list%
            </br><input type='submit'>
        </form>
    </body>
</html>